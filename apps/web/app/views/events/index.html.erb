<div class="page">
  <header class="page-header">
    <div>
      <h1>AgentMem Events</h1>
      <p class="subtitle">Captured agent events from AgentMem/UOCS.</p>
    </div>
    <div class="meta">
      <div class="meta-label">Source</div>
      <div class="meta-value"><%= @source_label %></div>
      <div class="meta-label">Count</div>
      <div class="meta-value">
        <%= @max_events && @events.size >= @max_events ? "#{@max_events}+" : @events.size %>
      </div>
      <div class="meta-label">Updated</div>
      <div class="meta-value" data-events-status>--:--:--</div>
    </div>
  </header>

  <section class="filters">
    <form method="get" action="/events" class="filters-form">
      <label>
        <span>Event</span>
        <select name="hook_event_type">
          <option value="">All</option>
          <% @filters[:hook_event_types].each do |value| %>
            <option value="<%= value %>" <%= "selected" if params[:hook_event_type] == value %>><%= value %></option>
          <% end %>
        </select>
      </label>
      <label>
        <span>Source</span>
        <select name="source_app">
          <option value="">All</option>
          <% @filters[:source_apps].each do |value| %>
            <option value="<%= value %>" <%= "selected" if params[:source_app] == value %>><%= value %></option>
          <% end %>
        </select>
      </label>
      <label>
        <span>Session</span>
        <select name="session_id">
          <option value="">All</option>
          <% @filters[:session_ids].each do |value| %>
            <option value="<%= value %>" <%= "selected" if params[:session_id] == value %>><%= value %></option>
          <% end %>
        </select>
      </label>
      <label>
        <span>Since</span>
        <select name="since">
          <option value="">Anytime</option>
          <% { "60" => "Last 60 min", "360" => "Last 6 hours", "1440" => "Last 24 hours", "10080" => "Last 7 days" }.each do |value, label| %>
            <option value="<%= value %>" <%= "selected" if params[:since] == value %>><%= label %></option>
          <% end %>
        </select>
      </label>
      <label class="filters-query">
        <span>Search</span>
        <input type="text" name="q" value="<%= params[:q] %>" placeholder="summary / payload / id" />
      </label>
      <div class="filters-actions">
        <button type="submit">Filter</button>
        <a class="clear" href="/events">Clear</a>
      </div>
    </form>
  </section>

  <% if @events.empty? %>
    <div class="empty-state">
      <p>No events found.</p>
      <p>
        Set <code>AGENTMEM_EVENTS_PATH</code> to a JSONL file containing events,
        then reload this page.
      </p>
    </div>
  <% else %>
    <section class="events" data-events-container>
      <%= render partial: "events/list", locals: { events: @events } %>
    </section>
  <% end %>
</div>

<script>
  (() => {
    const container = document.querySelector('[data-events-container]');
    if (!container) return;

    const statusEl = document.querySelector('[data-events-status]');
    const updateStatus = () => {
      if (!statusEl) return;
      statusEl.textContent = new Date().toLocaleTimeString();
    };

    const refresh = async () => {
      try {
        const response = await fetch('/events/list' + window.location.search);
        if (!response.ok) return;
        const html = await response.text();
        container.innerHTML = html;
        updateStatus();
      } catch (_) {
        // ignore fetch errors
      }
    };

    if (window.EventSource) {
      const source = new EventSource('/events/stream');
      source.addEventListener('update', () => refresh());
      source.addEventListener('error', () => {
        updateStatus();
      });
    } else {
      setInterval(refresh, 5000);
    }

    const refreshIfVisible = () => {
      if (document.visibilityState === 'visible') refresh();
    };

    document.addEventListener('visibilitychange', refreshIfVisible);
    window.addEventListener('focus', () => refresh());
    window.addEventListener('pageshow', () => refresh());
  })();
</script>
